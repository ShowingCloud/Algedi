# Database Schema Documentation

This document describes the database schema for the Algedi Multi-Tenant E-Commerce Platform.

## Schema Organization

The schema is organized into three logical domains within a single PostgreSQL database:

1. **Commerce Schema** - Core commerce entities
2. **CMS Schema** - Presentation layer
3. **Editor Schema** - AI memory and work in progress

## Commerce Schema

### Tenant
The root entity representing an agency/company.

- `id` (UUID, Primary Key)
- `stripeConnectId` (String, nullable) - For Stripe Connect revenue sharing
- `subscriptionTier` (String, default: "free") - free, pro, or enterprise
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Has many `Product`
- Has many `TenantCustomer`
- Has one `SiteConfig`
- Has many `PageTemplate`
- Has many `PromptLog`

### Product
Abstract product data, tenant-scoped.

- `id` (UUID, Primary Key)
- `tenantId` (UUID, Foreign Key → Tenant) - **RLS Key for tenant isolation**
- `attributes` (JSONB, nullable) - Flexible product data
- `inventoryCount` (Int, default: 0)
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Belongs to `Tenant`

**Indexes:**
- `tenantId` (for efficient tenant-scoped queries)

### Customer
Global customer profile (not tenant-specific).

- `id` (UUID, Primary Key)
- `email` (String, unique)
- `globalConsent` (Boolean, default: false) - Cross-tenant sharing opt-in
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Has many `TenantCustomer`

**Indexes:**
- `email` (for lookups)

### TenantCustomer
Junction table linking customers to tenants with tenant-specific preferences.

- `tenantId` (UUID, Foreign Key → Tenant, Composite Primary Key)
- `customerId` (UUID, Foreign Key → Customer, Composite Primary Key)
- `marketingOptIn` (Boolean, default: false) - Tenant-specific marketing consent
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Belongs to `Tenant`
- Belongs to `Customer`

**Indexes:**
- `tenantId`
- `customerId`

## CMS Schema

### SiteConfig
Tenant site configuration and theming.

- `tenantId` (UUID, Primary Key, Foreign Key → Tenant)
- `domain` (String)
- `themeTokens` (JSONB, nullable) - CSS variables and theme configuration
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Belongs to `Tenant` (one-to-one)

**Indexes:**
- `domain` (for domain lookups)

### PageTemplate
Page templates with structure JSON generated by the AI Editor.

- `id` (UUID, Primary Key)
- `tenantId` (UUID, Foreign Key → Tenant) - **Tenant-scoped**
- `structureJson` (JSONB, nullable) - Tree structure from Editor
- `isPublished` (Boolean, default: false)
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Belongs to `Tenant`

**Indexes:**
- `tenantId`
- `isPublished` (for filtering published templates)

## Editor Schema

### AssetDescription
AI-generated image descriptions with vector embeddings for semantic search.

- `imageHash` (String, Primary Key) - Unique identifier for the image file
- `aiDescription` (Text, nullable) - Generated by Vision LLM
- `embedding` (Vector, nullable) - For semantic search (requires pgvector extension)
- `createdAt`, `updatedAt` (Timestamps)

**Indexes:**
- `imageHash` (primary key, automatically indexed)

**Note:** The `embedding` field uses PostgreSQL's `vector` type. Ensure the `pgvector` extension is installed:
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### PromptLog
AI prompt logs with token usage tracking for billing.

- `id` (UUID, Primary Key)
- `tenantId` (UUID, Foreign Key → Tenant) - **Tenant-scoped for billing**
- `promptText` (Text) - The prompt sent to the LLM
- `generatedCode` (Text, nullable) - Generated React code
- `tokensUsed` (Int) - **CRITICAL for billing calculations**
- `createdAt`, `updatedAt` (Timestamps)

**Relations:**
- Belongs to `Tenant`

**Indexes:**
- `tenantId` (for tenant-scoped queries)
- `createdAt` (for time-based queries and billing aggregation)

## Multi-Tenancy & Security

### Row Level Security (RLS)

All tenant-scoped tables include `tenantId` fields with foreign key constraints to the `Tenant` table. This ensures:

1. **Data Isolation**: Each tenant can only access their own data
2. **Referential Integrity**: Cascade deletes when a tenant is removed
3. **Query Safety**: All queries must include `tenantId` filtering

### Required Query Pattern

⚠️ **CRITICAL**: Always include `tenantId` in queries for tenant-scoped tables:

```typescript
// ✅ CORRECT
const products = await prisma.product.findMany({
  where: { tenantId: currentTenantId }
});

// ❌ WRONG - Missing tenantId filter
const products = await prisma.product.findMany();
```

### Cascade Deletes

All tenant-scoped tables use `onDelete: Cascade`, meaning:
- When a `Tenant` is deleted, all related records are automatically deleted
- This prevents orphaned data and maintains data integrity

## Database Setup

1. **Create Database:**
   ```sql
   CREATE DATABASE algedi;
   ```

2. **Install pgvector Extension:**
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```

3. **Run Migrations:**
   ```bash
   cd packages/db
   pnpm migrate:dev
   ```

## Usage Example

```typescript
import { PrismaClient } from "@algedi/db";

const prisma = new PrismaClient();

// Get all products for a tenant
const products = await prisma.product.findMany({
  where: { tenantId: "tenant-uuid" },
  include: { tenant: true }
});

// Create a new page template
const template = await prisma.pageTemplate.create({
  data: {
    tenantId: "tenant-uuid",
    structureJson: { /* ... */ },
    isPublished: false
  }
});

// Log AI prompt usage
await prisma.promptLog.create({
  data: {
    tenantId: "tenant-uuid",
    promptText: "Generate a product page",
    generatedCode: "<Component />",
    tokensUsed: 150
  }
});
```

